image: node:14.15.0

definitions:
    services:
        mongo:
            image: mongo
        postgres:
            image: postgres
    steps:
        - step: &jest-test
              name: Jest Unit Tests
              caches:
                  - node
              services:
                  - mongo
              script:
                  - npm run decrypt -- local.settings.enc local.settings.json
                  - npm install
                  - npm test
        - step: &lint-test
              name: ESLint
              caches:
                  - node
              script:
                  - npm install eslint
                  - npx eslint .
        - step: &db-migration
              name: DB Migration
              caches:
                  - node
              script:
                  - npm install
                  - npm install -g knex
                  - npm run decrypt -- local.settings.enc local.settings.json
                  - node ./tools/init_database.js
                  - knex migrate:latest

pipelines:
    default:
        - step: *jest-test

    pull-requests:
        "**":
            - parallel:
                  - step: *lint-test
                  - step: *jest-test

    branches:
        "{STS-**,admin,andrey,ilya,justin,valeriy,vlad}":
            - parallel:
                  - step: *lint-test
                  - step: *jest-test
        "dev":
            - step:
                  <<: *db-migration
                  deployment: development
        "staging":
            - step:
                  <<: *db-migration
                  deployment: staging
        "production":
            - step:
                  <<: *db-migration
                  deployment: production
